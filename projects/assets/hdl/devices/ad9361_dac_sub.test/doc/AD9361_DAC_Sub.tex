\documentclass{article}
\iffalse
This file is protected by Copyright. Please refer to the COPYRIGHT file
distributed with this source distribution.

This file is part of OpenCPI <http://www.opencpi.org>

OpenCPI is free software: you can redistribute it and/or modify it under the
terms of the GNU Lesser General Public License as published by the Free Software
Foundation, either version 3 of the License, or (at your option) any later
version.

OpenCPI is distributed in the hope that it will be useful, but WITHOUT ANY
WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
PARTICULAR PURPOSE. See the GNU Lesser General Public License for more details.

You should have received a copy of the GNU Lesser General Public License along
with this program. If not, see <http://www.gnu.org/licenses/>.
\fi

\author{} % Force author to be blank
%----------------------------------------------------------------------------------------
% Paper size, orientation and margins
%----------------------------------------------------------------------------------------
\usepackage{geometry}
\geometry{
	letterpaper,			% paper type
	portrait,				% text direction
	left=.75in,				% left margin
	top=.75in,				% top margin
	right=.75in,			% right margin
	bottom=.75in			% bottom margin
 }
%----------------------------------------------------------------------------------------
% Header/Footer
%----------------------------------------------------------------------------------------
\usepackage{fancyhdr} \pagestyle{fancy} % required for fancy headers
\renewcommand{\headrulewidth}{0.5pt}
\renewcommand{\footrulewidth}{0.5pt}
\newcommand{\terminaloutput}[1]{\texttt{#1}}
\rhead{\small{ANGRYVIPER Team}}
%----------------------------------------------------------------------------------------
% Appendix packages
%----------------------------------------------------------------------------------------
\usepackage[toc,page]{appendix}
%----------------------------------------------------------------------------------------
% Defined Commands & Renamed Commands
%----------------------------------------------------------------------------------------
\renewcommand{\contentsname}{Table of Contents}
\renewcommand{\listfigurename}{List of Figures}
\renewcommand{\listtablename}{List of Tables}
\newcommand{\todo}[1]{\textcolor{red}{TODO: #1}\PackageWarning{TODO:}{#1}} % To do notes
\newcommand{\code}[1]{\texttt{#1}} % For inline code snippet or command line
%----------------------------------------------------------------------------------------
% Various pacakges
%----------------------------------------------------------------------------------------
\usepackage{scrextend}
\usepackage{hyperref} % for linking urls and lists
\usepackage{graphicx} % for including pictures by file
\usepackage{listings} % for coding language styles
\usepackage{rotating} % for sideways table
\usepackage{pifont}   % for sideways table
\usepackage{pdflscape} % for landscape view
\usepackage{longtable}
\usepackage{textcomp}
%----------------------------------------------------------------------------------------
% Table packages
%----------------------------------------------------------------------------------------
\usepackage{tabularx} % c=center,l=left,r=right,X=fill
\usepackage{float}
\floatstyle{plaintop}
\usepackage[tableposition=top]{caption}
\newcolumntype{P}[1]{>{\centering\arraybackslash}p{#1}}
\newcolumntype{M}[1]{>{\centering\arraybackslash}m{#1}}
%----------------------------------------------------------------------------------------
% Block Diagram / FSM Drawings
%----------------------------------------------------------------------------------------
\usepackage{tikz}
\usetikzlibrary{shapes,arrows,fit,positioning}
\usetikzlibrary{automata} % used for the fsm
\usetikzlibrary{calc} % For duplicating clients
\usepgfmodule{oo} % To define a client box
%----------------------------------------------------------------------------------------
% Colors Used
%----------------------------------------------------------------------------------------
\usepackage{colortbl}
\definecolor{blue}{rgb}{.7,.8,.9}
\definecolor{ceruleanblue}{rgb}{0.16, 0.32, 0.75}
\definecolor{drkgreen}{rgb}{0,0.6,0}
\definecolor{deepmagenta}{rgb}{0.8, 0.0, 0.8}
\definecolor{cyan}{rgb}{0.0,0.6,0.6}
\definecolor{maroon}{rgb}{0.5,0,0}
\usepackage{multirow}
%----------------------------------------------------------------------------------------
% Update the docTitle and docVersion per document
%----------------------------------------------------------------------------------------
\def\docTitle{Component Data Sheet}
\def\docVersion{1.3}
%----------------------------------------------------------------------------------------
\date{Version \docVersion} % Force date to be blank and override date with version
\title{\docTitle}
\lhead{\small{\docTitle}}

\def\comp{ad9361\_dac\_sub}
\edef\ecomp{ad9361_dac_sub}
\def\Comp{AD9361 DAC Sub}
\graphicspath{ {figures/} }

\begin{document}

\section*{Summary - \Comp}
\begin{tabular}{|c|M{13.5cm}|}
	\hline
	\rowcolor{blue}
	                  &                  \\
	\hline
	Name              & \comp            \\
	\hline
	Worker Type       & Device           \\
	\hline
	Version           & v\docVersion     \\
	\hline
	Release Date      & Aug 2017         \\
	\hline
	Component Library & ocpi.assets.devices     \\
	\hline
	Workers           & \comp.hdl        \\
	\hline
	Tested Platforms  &  Zedboard (ISE and Vivado), ML605 (FMC LPC slot) \\
	\hline
\end{tabular}

\section*{Functionality}
	The \Comp{} is a subdevice worker whose primary purpose is to time-interleave data streams for two TX channels in preparation for sending to the AD9361 IC pins (independent of which of the IC's P0/P1 buses the TX data streams are sent to). Time-interleaving occurs according to the timing diagrams specified in figures 66, 69, 72, 75, and 80 in \cite{adi_ug570}. This worker ingests data from at most two instances of the ad9361\_dac.hdl device worker, each which handles a single TX channel data stream, and time-interleaves all channels onto a single data bus that is sent out eventually (via devsignals to ad9361\_data\_sub.hdl\cite{data_sub_comp_datasheet}) to the appropriate TX data stream pins of the AD9361 IC\cite{ad9361}.

\section*{Worker Implementation Details}
\subsection*{\comp.hdl}
\begin{sloppypar}
The \comp.hdl subdevice worker handles registering and interleaving of two independent TX data streams which are sent to this worker via the \verb+dev_data_ch0_in+ and \verb+dev_data_ch1_in+ devsignal ports. Data is sent out via the \verb+dev_data_to_pins+ devsignal port which ad9361\_data\_sub.hdl routes to the AD9361\cite{data_sub_comp_datasheet}. This worker's \verb+LVDS_p+, \verb+HALF_DUPLEX_p+, \verb+SINGLE_PORT_p+, and \verb+DATA_RATE_CONFIG_p+ parameter properties enforce build-time configuration\footnote{Although parameter property infrastructure is in place for all data interface configurations, LVDS is the only currently supported configuration.} for all of the possible AD9361 TX data time-interleaved modes:
\begin{itemize}
	\item CMOS Single Port Half Duplex SDR,
	\item CMOS Single Port Half Duplex DDR,
	\item CMOS Single Port Full Duplex SDR,
	\item CMOS Single Port Full Duplex DDR,
	\item CMOS Dual Port Half Duplex SDR,
	\item CMOS Dual Port Half Duplex DDR,
	\item CMOS Dual Port Full Duplex SDR,
	\item CMOS Dual Port Full Duplex DDR, and
	\item LVDS (Dual Port Full Duplex DDR).
\end{itemize}
\pagebreak
Note that "channel 0" within the context of this worker corresponds to the AD9361 T1 channel and "channel 1" corresponds to the AD9361 T2 channel in the AD9361 timing diagrams\footnote{For more info, see e.g. Figure 80 in \cite{adi_ug570}.}. The mapping between the AD9361's T1/T2 channels and the AD9361 physical TX connector outputs is variable depending on the AD9361 register configuration. This relationship is shown in the following table.  Due to the AD9361's T2 behavior\footnote{\label{t2}Data sent via T2 is only ever transmitted when the AD9361 register 0x002 Bits D7 and D6 are 1 (which corresponds to one of 1R2T or 2R2T modes).}, channel 1 should only ever be used when 2 TX channels are desired.
\end{sloppypar}
\begin{scriptsize}
	\centering
	\begin{longtable}{|p{3cm}|p{1.8cm}|p{3.5cm}|p{1.9cm}|p{2.1cm}|p{2cm}|}
		\caption{Channel Connectivity (D.C. means Don't Care.)} \\
		\hline
		\rowcolor{blue}
		\comp.hdl & AD9361  & AD9361 TX RF Port & AD9361 & AD9361 & AD9361 \\
		\rowcolor{blue}
		devsignal channel & timing &   & Register 0x010 & Register 0x002 & Register 0x004 \\
		\rowcolor{blue}
		& diagram  & & Bit D5\footnote{Note that AD9361 register 0x010 Bit D5 is controlled by no-OS's AD9361\_InitParam struct's tx\_channel\_swap\_enable member\cite{adi_ug570} and that the ad9361\_config\_proxy.rcc worker's \texttt{ad9361\_init} property sets that member value\cite{config_proxy_comp_datasheet}.} & Bits [D7 D6]\footnote{Note that AD9361 register 0x002 Bits [D7 D6] are controlled by no-OS's AD9361\_InitParam struct's one\_rx\_one\_tx\_use\_tx\_num member and two\_rx\_two\_tx\_mode\_enable member\cite{adi_ug570} and that the ad9361\_config\_proxy.rcc worker's \texttt{ad9361\_init} property sets these member values\cite{config_proxy_comp_datasheet}.} & Bit D6 \\
		\rowcolor{blue}
		& channel & & (channel swap) & (channel enable) & (port select) \\
		\hline
		0 & T1 & TX1A         & 0 & [D.C. 1]  & 0 \\
		0 & T1 & TX1B         & 0 & [D.C. 1]  & 1 \\
		\hline
		0 & T1 & TX2A         & 1 & [1 D.C.] & 0 \\
		0 & T1 & TX2B         & 1 & [1 D.C.] & 1 \\
		\hline
		1 \footref{t2}  & T2 \footref{t2} & TX2A         & 0 & [1 1]  & 0 \\
		1 \footref{t2} & T2 \footref{t2} & TX2B         & 0 & [1 1]  & 1 \\
		\hline
		1 \footref{t2} & T2 \footref{t2} & TX1A         & 1 & [1 1] & 0 \\
		1 \footref{t2} & T2 \footref{t2} & TX1B         & 1 & [1 1] & 1 \\
		\hline
	\end{longtable}
\end{scriptsize}

\section*{Block Diagrams}
\subsection*{Top level}
\makeatletter
\newcommand{\gettikzxy}[3]{%
  \tikz@scan@one@point\pgfutil@firstofone#1\relax
  \edef#2{\the\pgf@x}%
  \edef#3{\the\pgf@y}%
}
\makeatother
\pgfooclass{clientbox}{ % This is the class clientbox
    \method clientbox() { % The clientbox
    }
    \method apply(#1,#2,#3,#4) { % Causes the clientbox to be shown at coordinate (#1,#2) and named #3
        \node[rectangle,draw=white,fill=white] at (#1,#2) (#3) {#4};
    }
}
\pgfoonew \myclient=new clientbox()
\begin{center}
  \begin{tikzpicture}[% List of styles applied to all, to override specify on a case-by-case
      every node/.style={
        align=center,      % use this so that the "\\" for line break works
        minimum size=1cm,  % creates space above and below text in rectangle
      },
      every edge/.style={draw,thick}
    ]
    \node[rectangle,ultra thick,draw=black,fill=blue,minimum size=2cm,minimum width=16cm](R1){ Parameter Properties:\\ \verb+LVDS_p+, \verb+HALF_DUPLEX_p+, \verb+SINGLE_PORT_p+, \verb+DATA_RATE_CONFIG_p+ \\ \\ \\ \Comp \\ \\ };
    \node[rectangle,draw=white,fill=white](R4)[above= of R1]{ };
    \node[rectangle,draw=white,fill=white](placeholder)[above= of R1] {  };
	(R1)edge []	node [] {} (R4)
	(R4)edge []	node [] {} (R1)
    ;
    \gettikzxy{(placeholder)}{\rx}{\ry}
    \myclient.apply(\rx - 150,\ry,C1, ``dev\_data\_ch0\_in'' \\ dev signal port \\ DAC channel's data bus sent from \\ instance of ad9361\_dac.hdl);
    \path[<->]($(R1.north) + (-150 pt,0)$) edge [] node [] {} (C1);
    \myclient.apply(-\rx + 150,\ry,C1, ``dev\_data\_ch1\_in'' \\ dev signal port \\ DAC channels' data bus sent from \\ instance of ad9361\_dac.hdl);
    \path[<->]($(R1.north) + (150 pt,0)$) edge [] node [] {} (C1);
    
	\fontsize{9.5}{12}\selectfont    
    
    \myclient.apply(\rx - 167.5,\ry-180,C1, ``dev\_cfg\_data'' \\ dev signal port \texttt{(}see \\ AD9361\_CONFIG.pdf\texttt{)});
    \path[<->]($(R1.south) + (-167.5 pt,0)$) edge [] node [] {} (C1);
    \myclient.apply(\rx - 52.5,\ry-180,C1, ``dev\_cfg\_data\_tx'' \\ dev signal port \texttt{(}see \\ AD9361\_CONFIG.pdf\texttt{)} );
    \path[<-]($(R1.south) + (-52.5 pt,0)$) edge [] node [] {} (C1);
    \myclient.apply(\rx + 52.5,\ry-180,C1, ``dev\_cfg\_data\_clk'' \\ dev signal port \texttt{(}see \\ AD9361\_DATA\_SUB.pdf\texttt{)} );
    \path[<-]($(R1.south) + (52.5 pt,0)$) edge [] node [] {} (C1);
    \myclient.apply(\rx + 167.5,\ry-180,C1, ``dev\_cfg\_data\_to\_pins'' \\ dev signal port \texttt{(}see \\ AD9361\_DATA\_SUB.pdf\texttt{)} );
    \path[->]($(R1.south) + (167.5 pt,0)$) edge [] node [] {} (C1);

  \end{tikzpicture}
\end{center}
\pagebreak
\section*{Source Dependencies}
\subsection*{\comp.hdl}
\begin{itemize}
	\item opencpi/hdl/devices/ad9361\_dac\_sub.hdl/ad9361\_dac\_sub.vhd
	\item opencpi/hdl/primitives/bsv/imports/SyncBit.v
	\item opencpi/hdl/primitives/bsv/bsv\_pkg.vhd
\end{itemize}
\begin{landscape}

	\section*{Component Spec Attributes}
	\begin{scriptsize}
		\begin{tabular}{|p{3.75cm}|p{19.34cm}|}
			\hline
			\rowcolor{blue}
			Attribute & Value \\
			\hline
			NoControl & True \\
			\hline
		\end{tabular}
	\end{scriptsize}
	
	\section*{Component Spec Properties}
	\begin{scriptsize}
		\begin{tabular}{|p{3.75cm}|p{1.25cm}|p{2cm}|p{2.75cm}|p{1.5cm}|p{1.5cm}|p{1cm}|p{6.74cm}|}
			\hline
			\rowcolor{blue}
			Name               & Type & SequenceLength & ArrayDimensions & Accessibility      & Valid Range & Default & Usage                                                                               \\
			\hline
			- & - & - & - & - & - & - & - \\
			\hline
		\end{tabular}
	\end{scriptsize}

	\section*{Worker Properties}
	\subsection*{\comp.hdl}
	\begin{scriptsize}
		\begin{tabular}{|p{2cm}|p{2.5cm}|p{1cm}|p{2cm}|p{2cm}|p{1.75cm}|p{2cm}|p{1.25cm}|p{5.55cm}|}
			\hline
			\rowcolor{blue}
			Scope        & Name                 & Type & SequenceLength & ArrayDimensions & Accessibility & Valid Range        & Default & Usage                                                                                                                  \\
			\hline
			Property     & \verb+LVDS_p+        & Bool & -              & -               & Parameter        & Standard           & False   & Use LVDS TX data bus interleaving scheme, otherwise use CMOS interleaving scheme. Default is CMOS. \\
			\hline
			Property     & \verb+HALF_DUPLEX_p+ & Bool & -              & -               & Parameter        & Standard           & False   & Use half duplex mode, otherwise use full duplex mode. Must be false when using LVDS mode. \\
			\hline
			Property     & \verb+SINGLE_PORT_p+ & Bool & -              & -               & Parameter        & Standard           & False   & Use single port, otherwise use both (dual) ports.  Default is to use both ports. Must be false when using LVDS mode. \\
			\hline
			Property     & \verb+DATA_RATE_CONFIG_p+&Enum&-             & -               & Parameter        & SDR, DDR           & DDR     & This should have a value of DDR when \verb+LVDS_p+ has a value of true. Either value is acceptable when \verb+LVDS_p+ has a value of false (i.e. CMOS mode is used). \\
			\hline
		\end{tabular}
	\end{scriptsize}

	\section*{Component Ports}
	\begin{scriptsize}
		\begin{tabular}{|p{2cm}|p{1.5cm}|p{4cm}|p{1.5cm}|p{1.5cm}|p{10.85cm}|}
			\hline
			\rowcolor{blue}
			Name & Producer & Protocol           & Optional & Advanced & Usage                  \\
			\hline
			-    & -        & -                  & -        & -        & - \\
			\hline
		\end{tabular}
	\end{scriptsize}

\pagebreak
	\section*{Worker Interfaces}
	\subsection*{\comp.hdl}
	\begin{scriptsize}
		\begin{longtable}{|p{1.75cm}|p{2.25cm}|p{1.25cm}|p{1.25cm}|p{1.25cm}|p{3cm}|p{1.4cm}|p{0.9cm}|p{6.88cm}|}
			\hline
			\rowcolor{blue}
			Type                       & Name                            & Count & Optional & Master                & Signal                & Direction                  & Width                    & Description                                                                                                                  \\
			\hline
			\multirow{38}{*}{DevSignal} & \multirow{38}{*}{dev\_cfg\_data} & \multirow{38}{*}{1} & \multirow{38}{*}{False} & \multirow{38}{*}{True} & config\_is\_two\_r &Input& 1      & Some data port configurations (such as LVDS) require the TX bus to use 2R2T timing if either 2 TX or 2 RX channels are used. For example, if using LVDS and this has a value of 1, 2R2T timing will be forced. \\
			\cline{6-9}
			&             &        &     &      & ch0\_handler\_is\_present &Output & 1      & Value is 1 if the dev\_data\_ch0 dev signal is connected to a worker (that "handles" the data) and 0 otherwise. This is expected to be hardcoded at buildtime. \\
			\cline{6-9}
			&             &        &     &      & ch1\_handler\_is\_present &Output & 1      &  Value is 1 if the dev\_data\_ch1 dev signal is connected to a worker (that "handles" the data) and 0 otherwise. This is expected to be hardcoded at buildtime. \\
			\cline{6-9}
			&             &        &     &      & data\_bus\_index\_direction &Output&1      &  Value is 1 if the bus indexing of the P0\_D/P1\_D signals from dev\_data\_from\_pins was reversed before processing. This is expected to be hardcoded at buildtime. \\
			\cline{6-9}
			&             &        &     &      & data\_clk\_is\_inverted     &Output& 1      & Value is 1 if the clock in via dev\_data\_clk was inverted inside this worker before used as an active-edge rising clock. This is expected to be hardcoded at buildtime. \\
			\cline{6-9}
			&             &        &     &      & islvds       & Output     & 1      &  Value is 1 if \verb+LVDS_p+ has a value of true and 0 if \verb+LVDS_p_p+ has a value of false. Because \verb+LVDS_p+ is a parameter property, this is hardcoded at buildtime. The purpose of this devsignal is to feed this worker's buildtime-specified LVDS/CMOS mode through ad9361\_config.hdl to ad9361\_config\_proxy.rcc so No-OS knows which LVDS/CMOS mode to use when initializing the AD9361 IC. \\
			\cline{6-9}
			&             &        &     &      & isdualport   & Output     & 1      &  Value is 1 if \verb+SINGLE_PORT_p+ has a value of false and 0 if \verb+SINGLE_PORT_p+ has a value of true. Because \verb+SINGLE_PORT_p+ is a parameter property, this is hardcoded at buildtime. The purpose of this devsignal is to feed this worker's buildtime-specified single/dual port mode through ad9361\_config.hdl to ad9361\_config\_proxy.rcc so No-OS knows which single/dual port mode to use when initializing the AD9361 IC. \\
			\cline{6-9}
			&             &        &     &      & isfullduplex & Output     & 1      &  Value is 1 if \verb+HALF_DUPLEX_p+ has a value of false and 0 if \verb+HALF_DUPLEX_p+ has a value of true. Because \verb+HALF_DUPLEX_p+ is a parameter property, this is hardcoded at buildtime. The purpose of this devsignal is to feed this worker's buildtime-specified half/full duplex mode through ad9361\_config.hdl to ad9361\_config\_proxy.rcc so No-OS knows which half/full duplex mode to use when initializing the AD9361 IC. \\
			\cline{6-9}
			&             &        &     &      & isDDR        & Output     & 1      &  Value is 1 if \verb+DATA_RATE_CONFIG_p+ has a value of DDR and 0 if \verb+DATA_RATE_CONFIG_p+ has a value of SDR. Because \verb+DATA_RATE_CONFIG_p+ is a parameter property, this is hardcoded at buildtime. The purpose of this devsignal is to feed this worker's buildtime-specified SDR/DDR mode through ad9361\_config.hdl to ad9361\_config\_proxy.rcc so No-OS knows which half/full duplex mode to use when initializing the AD9361 IC.\\
			\cline{6-9}
			&             &        &     &      & present      & Output     & 1      &  Used to communicate to ad9361\_config.hdl that it should validate the islvds, isdualport, isfullduplex, and isddr signals against similar signals in the ad9361\_adc\_sub.hdl and ad9361\_data\_sub.hdl workers if they are present in the bitstream. This is expected to be hardcoded at buildtime. \\
			\cline{6-9}
			\hline
			\multirow{6}{*}{DevSignal} & \multirow{6}{*}{dev\_cfg\_data\_tx} & \multirow{6}{*}{1} & \multirow{6}{*}{False} & \multirow{6}{*}{True}  & config\_is\_two\_t & Input     & 1      & Some data port configurations (such as LVDS) require the TX bus to use 2R2T timing if either 2 TX or 2 RX channels are used. For example, if using LVDS and this has a value of 1, 2R2T timing will be forced.\\
			\cline{6-9}
			&             &        &     &      & force\_two\_r\_two\_t\_timing &Input& 1 & Expected to match value of AD9361 register 0x010 bit D2\cite{adi_ug671}.\\
			\hline
			DevSignal     & dev\_data\_clk & 1  & False & True & DATA\_CLK\_P & Input     & 1      & Buffered version of AD9361 DATA\_CLK\_P pin. \\
			\hline
			\multirow{18}{*}{DevSignal}     & \multirow{18}{*}{dev\_data\_to\_pins} &\multirow{18}{*}{1} & \multirow{18}{*}{False} & \multirow{18}{*}{True}  & \multirow{14}{*}{data} & \multirow{14}{*}{Output}     & \multirow{14}{*}{24}      & Data bus containing configuration-specific AD9361 pins corresponding to the TX data path: \\
			&  &  &     &      &  &      &       & * CMOS single port half duplex: [12'b0 P0\_D[11:0]], \\
			&  &  &     &      &  &      &       & * CMOS single port full duplex: [18'b0 P0\_D[11:6]], \\
			&  &  &     &      &  &      &       & * CMOS dual port half duplex: [P0\_D[11:0] P1\_D[11:0]], \\
			&  &  &     &      &  &      &       & * CMOS dual port full duplex: [12'b0 P1\_D[11:0]], \\
			&  &  &     &      &  &      &       & * LVDS: [18'b0 TX\_D[5:0]], \\
			&  &  &     &      &  &      &       & or, if ports are swapped: \\
			&  &  &     &      &  &      &       & * CMOS single port half duplex: [12'b0 P1\_D[11:0]], \\
			&  &  &     &      &  &      &       & * CMOS single port full duplex: [18'b0 P1\_D[11:6]], \\
			&  &  &     &      &  &      &       & * CMOS dual port half duplex: [P1\_D[11:0] P0\_D[11:0]], \\
			&  &  &     &      &  &      &       & * CMOS dual port full duplex: [12'b0 P0\_D[11:0]], \\
			&  &  &     &      &  &      &       & * LVDS: (unsupported with port swap). \\
			&  &  &     &      &  &      &       & For more info see \cite{data_sub_comp_datasheet}. \\
			\cline{6-9}
			&  &  &     &      &tx\_frame&Output&1& Signal which will drive the output buffer which drives the AD9361 TX\_FRAME\_P pin. \\
			\cline{6-9}
			&  &  &     &      &fb\_clk  &Output&1& Signal which will drive the output buffer which will drive the AD9361 FB\_CLK\_P pin. \\
			\hline
			\multirow{15}{*}{DevSignal} & \multirow{15}{*}{dev\_data\_ch0\_in} & \multirow{15}{*}{1} & \multirow{15}{*}{False} & \multirow{15}{*}{False}  & present & Output&1& Value is 1 if a worker is connected to this devsignal port. \\
			\cline{6-9}
			&             &        &     &      & dac\_clk     & Input     & 1      & Clock for dac\_ready, dac\_take, dac\_data\_I, and dac\_data\_Q. \\
			\cline{6-9}
			&             &        &     &      & dac\_ready   & Output    & 1      & Indicates that the dac\_data\_I and dac\_data\_Q are valid/ready to be latched on the next rising edge of adc\_clk. \\
			\cline{6-9}
			&             &        &     &      & dac\_take    & Input     & 1      & Indicates that dac\_data\_I and dac\_data\_Q were latched on the previous rising edge of dac\_clk. If in the previous clock cycle dac\_ready was 1, the values of dac\_data\_I and dac\_data\_Q should not be allowed to update with a new sample until dac\_take is 1. \\
			\cline{6-9}
			&             &        &     &      & dac\_data\_I & Output    & 12     & Signed Q0.11 I value of DAC sample corresponding to RX channel 0. \\
			\cline{6-9}
			&             &        &     &      & dac\_data\_Q & Output    & 12     & Signed Q0.11 Q value of DAC sample corresponding to RX channel 0. \\
			\hline
			\multirow{15}{*}{DevSignal} & \multirow{15}{*}{dev\_data\_ch1\_in} & \multirow{15}{*}{1} & \multirow{15}{*}{True} & \multirow{15}{*}{False}  & present & Output&1& Value is 1 if a worker is connected to this devsignal port. \\
			\cline{6-9}
			&             &        &     &      & dac\_clk     & Input     & 1      & Clock for dac\_ready, dac\_take, dac\_data\_I, and dac\_data\_Q. \\
			\cline{6-9}
			&             &        &     &      & dac\_ready   & Output    & 1      & Indicates that the dac\_data\_I and dac\_data\_Q are valid/ready to be latched on the next rising edge of adc\_clk. \\
			\cline{6-9}
			&             &        &     &      & dac\_take    & Input     & 1      & Indicates that dac\_data\_I and dac\_data\_Q were latched on the previous rising edge of dac\_clk. If in the previous clock cycle dac\_ready was 1, the values of dac\_data\_I and dac\_data\_Q should not be allowed to update with a new sample until dac\_take is 1. \\
			\cline{6-9}
			&             &        &     &      & dac\_data\_I & Output    & 12     & Signed Q0.11 I value of DAC sample corresponding to RX channel 1. \\
			\cline{6-9}
			&             &        &     &      & dac\_data\_Q & Output    & 12     & Signed Q0.11 Q value of DAC sample corresponding to RX channel 1. \\
			\hline
		\end{longtable}
	\end{scriptsize}
	
	\section*{Subdevice Connections}
	\begin{scriptsize}
		\begin{tabular}{|p{5cm}|p{5cm}|p{5cm}|p{7.22cm}|}
			\hline
			\rowcolor{blue}
			Supports Worker & Supports Worker Port & \comp{}.hdl Port     & \comp{}.hdl Port Index \\
			\hline
			ad9361\_dac     & dev\_dac             & dev\_data\_ch0\_in & 0 \\
			\hline
			ad9361\_dac     & dev\_dac             & dev\_data\_ch1\_in & 0 \\
			\hline
		\end{tabular}
	\end{scriptsize}

\end{landscape}

\section*{Control Timing and Signals}
The \Comp{} subdevice worker contains four clock domains: control plane, FB\_CLK\_P, "dac\_clk" and "dad2\_clk".
\subsection*{Control Plane Clock Domain}
The \verb+data_cfg_tx+ signals enter this worker in the control plane clock domain. Inside this worker, they are combined combinatorially into a single signal which is subsequently synchronized to the dacd2\_clk domain. The dacd2\_clk domain signal is then used to handle time-interleaving of multiple channel's data.
\subsection*{DATA\_CLK\_P/FB\_CLK\_P Clock Domain}
The AD9361 DATA\_CLK\_P clock enters this worker via the \verb+dev_data_clk+ devsignal. DATA\_CLK\_P clock is forwarded to the \verb+FB_CLK_P+ device signal as well as used to generate dac\_clk.
\subsection*{"dac\_clk" Clock Domain}
The "dac\_clk" clock is an inverted version of DATA\_CLK\_P. Note that data transitions for the TX data sent out via the \verb+dev_data_to_pins+ devsignal port are falling-edge aligned with \verb+FB_CLK_P+ since the falling edge is what the AD9361 datasheets specifies its setup/hold requirements against\cite{adi_ug570}. The dac\_clk domain allows for logic within this worker to be falling edge aligned with \verb+FB_CLK_P+.
\subsection*{"dacd2\_clk" Clock Domain}
The "dacd2\_clk" clock is a divided by 2 version of "dac\_clk". TX data for channel 0 and channel 1 enter this worker in the dacd2\_clk domain from the  \verb+dev_data_ch0_in+ and \verb+dev_data_ch1_in+ devsignal ports, respectively. The dacd2\_clk clock was a necessary replacement for some of the dac\_clk logic in order to alleviate timing violations in the dac\_clk domain for the zed\_ise platform. Note that because dacd2\_clk is a divided version of dac\_clk, synchronization logic between the two is not necessary and not included.
\subsection*{Data latency}
\begin{itemize}
\item{\textbf{LVDS}} \\ Latency for LVDS is given as the number of clock cycles from a given channel's data becoming ready on the dac\_data\_I and dac\_data\_Q devsignals to the starting edge of the high 6-bit I word on the AD9361 data bus output. Note that, for multichannel modes, latency can be two possible values depending on the current state of the 2-state channel serialization state machine exists when dac\_data\_I/dac\_data\_Q becomes ready. The latency for the various LVDS configurations are as follows:
\begin{itemize}
	\item{1R1T} \\channel 0 data latency = 3 FB\_CLK\_P cycles (2 are pipeline delay which are arguably unnecessary and 1 is a 12-bit word to 6-bit word serialization register),
	\item{2R1T/1R2T/2R2T} \\channel 0 data latency = 3 or 5 FB\_CLK\_P cycles (2 are pipeline delay which are arguably unnecessary, 2 are possible channel serialization register delay, and 1 is a 12-bit word to 6-bit word serialization register), \\channel 1 data latency = 3 or 5 FB\_CLK\_P cycles (2 are pipeline delay which are arguably unnecessary, 2 are possible channel serialization register delay, and 1 is a 12-bit word to 6-bit word serialization register).
\end{itemize}
\item{\textbf{CMOS}} \\ Not yet implemented or supported.
\end{itemize}
\pagebreak
\subsection*{Multichannel Phase Coherency}
Note that the two channel data made available via dev\_data\_ch0\_in and dev\_data\_ch1\_in are only ever considered to be phase coherent if coherency is guaranteed by the worker(s) that dev\_data\_ch0\_in and dev\_data\_ch1\_in are connected to. For example, multiple instances of ad9361\_dac.hdl would not guarantee phase coherence because their datastreams would be independent. However, if a single device worker was created which interfaced with both dev\_data\_ch0\_in and dev\_data\_ch1\_in, phase coherency could be guaranteed by updating the values for the two channels in an every-other-clock fashion.

\section*{Performance and Resource Utilization}
\subsubsection*{\comp.hdl}
Fmax refers to the maximum allowable clock rate for any registered signal paths within a given clock domain for an FPGA design. Fmax in the table below is specific only to this worker and represents the maximum possible Fmax for any OpenCPI bitstream built with this worker included. Note that the Fmax value for a given clock domain for the final bitstream is often worse than the Fmax specific to this worker, even if this worker is the only one included in the bitstream. Note also that the DATA\_CLK\_P devsignal's rate will only ever go as high as 245.76 MHz\cite{adi_ug570}. \\ \\
Table entries are a result of building the worker with the following parameter property sets:
%\input{../../\ecomp.hdl/utilization.inc}
\begin{itemize}
	\item \verb+LVDS_p+=True
	\item \verb+HALF_DUPLEX_p+=False
	\item \verb+SINGLE_PORT_p+=False
	\item \verb+DATA_RATE_CONFIG_p+=DDR
\end{itemize}
% see performance_and_resource_utilization.txt
\begin{scriptsize}
	\begin{longtable}{|M{4.5cm}|M{2cm}|M{2cm}|M{2cm}|M{2.5cm}|M{2cm}|}
		\hline
		\rowcolor{blue}
		Device                       & Registers (typical) & LUTs (typical) & Fmax (typical) (dev\_data\_clk) & Memory/Special Functions   & Design Suite       \\
		\hline
		\multirow{2}{*}{Zynq XC7Z020-1-CLG484} & 91  & 88            & 286 MHz \textsuperscript{\ref{abc}} & 2 BUFR, 8 ODDR             & Vivado 2017.1      \\
    \cline{2-6}
		                             & 99            & 105           & 704 MHz             & 2 BUFR, 8 ODDR             & ISE 14.7           \\
		\hline
		Virtex-6 XC6VLX240T-1-FF1156 & 99            & 105           & 632 MHz             & 2 BUFR, 8 ODDR             & ISE 14.7           \\
		\hline
		Stratix IV EP4SGX230K-C2-F40 & (unsupported) & (unsupported) & \ref{quartustiming} & (unsupported)              & Quartus Prime 15.1 \\
		\hline
	\end{longtable}
\end{scriptsize}
\footnotetext[1]{\label{abc}These measurements were the result of a Vivado timing analysis which was different from the Vivado analysis performed by default for OpenCPI worker builds. For more info see Appendix \ref{appendix}}
\footnotetext[2]{\label{quartustiming}Quartus does not perform timing analysis at the OpenCPI worker build (i.e. synthesis) stage.}
\section*{Test and Verification}
The test outlined in \cite{dac_comp_datasheet} includes validation of this worker's functionality (for LVDS only). Note that this worker does not successfully operate with the FMCOMMS2/3 card on the ML605 FMC-HPC slot due to an unknown data fidelity issue.
\pagebreak
\begin{thebibliography}{1}

\bibitem{ad9361} AD9361 Datasheet and Product Info \\
\url{http://www.analog.com/en/products/rf-microwave/integrated-transceivers-transmitters-receivers/wideband-transceivers-ic/ad9361.html}
\bibitem{adi_ug570} AD9361 Reference Manual UG-570\\
AD9361\_Reference\_Manual\_UG-570.pdf
\bibitem{adi_ug671} AD9361 Register Map Reference Manual UG-671\\
AD9361\_Register\_Map\_Reference\_Manual\_UG-671.pdf
\bibitem{data_sub_comp_datasheet} AD361 Data Sub Component Data Sheet \\AD9361\_Data\_Sub.pdf
\bibitem{dac_comp_datasheet} AD361 DAC Component Data Sheet \\AD9361\_DAC.pdf
\bibitem{config_proxy_comp_datasheet} AD361 Configy Proxy Component Data Sheet \\AD9361\_Config\_Proxy.pdf

\end{thebibliography}
\pagebreak
\section{Appendix - Vivado Timing Analysis} \label{appendix}
The Vivado timing report that OpenCPI runs for device workers erroneously reports net delays which are not indicative of the maximum allowable clock rate for a given clock pin. Custom Vivado tcl commands have to be run device workers to calculate this information. \\ \\
The desired maximum clock rate for the DATA\_CLK\_P clock domain for this worker is computed as the inverse of the DATA\_CLK\_P clock period which causes the worst case slack to be 0 ns. In preparation for running the timing analys, build the worker, source the Vivado settings64.sh script, the run the following commands from the base project directory):
\lstset{language=bash, columns=flexible, breaklines=true, prebreak=\textbackslash, basicstyle=\ttfamily, showstringspaces=false,upquote=true, aboveskip=\baselineskip, belowskip=\baselineskip, upquote=true}
\begin{lstlisting}
cd hdl/devices/
vivado -mode tcl
open_project ad9361_dac_sub.hdl/target-zynq/ad9361_dac_sub_rv.xpr
synth_design -part xc7z020clg484-1 -top ad9361_dac_sub_rv -mode out_of_context
\end{lstlisting}
To get the desired period, we must define DATA\_CLK\_P as a clock in Vivado (create\_clock command) with some arbitrarily chosen period (we chose 0.001 ns). Note that get\_nets dev\_data\_clk* returns dev\_data\_clk\_in[DATA\_CLK\_P], which is the desired DATA\_CLK\_P net which is passed into this device worker via the dev\_data\_clk\_in devsignal.
\begin{lstlisting}
create_clock -name clk2 -period 0.001 [get_nets dev_data_clk*]
\end{lstlisting}
The timing report is then run to to report the worst case slack for our defined clock period.
\begin{lstlisting}
report_timing -delay_type min_max
\end{lstlisting}
The following is the output of this report:
\fontsize{6}{12}\selectfont
\begin{lstlisting}

Timing Report

Slack (VIOLATED) :        -3.485ns  (required time - arrival time)
  Source:                 worker/data_mode_lvds.reg_duplication_loop[6].dacd2_ch0_i_r_reg[6]/C
                            (rising edge-triggered cell FDRE clocked by dev_data_ch1_in_out[dac_clk]  {rise@0.001ns fall@0.002ns period=0.002ns})
  Destination:            worker/data_mode_lvds.dac_data_ddr_first_r_reg[0]/D
                            (rising edge-triggered cell FDRE clocked by clk2'  {rise@0.000ns fall@0.001ns period=0.001ns})
  Path Group:             clk2
  Path Type:              Setup (Max at Slow Process Corner)
  Requirement:            0.002ns  (clk2 fall@0.002ns - dev_data_ch1_in_out[dac_clk] rise@0.001ns)
  Data Path Delay:        1.772ns  (logic 1.020ns (57.562%)  route 0.752ns (42.438%))
  Logic Levels:           2  (LUT3=1 MUXF7=1)
  Clock Path Skew:        -1.760ns (DCD - SCD + CPR)
    Destination Clock Delay (DCD):    2.709ns = ( 2.712 - 0.002 ) 
    Source Clock Delay      (SCD):    4.632ns = ( 4.633 - 0.001 ) 
    Clock Pessimism Removal (CPR):    0.163ns
  Clock Uncertainty:      0.035ns  ((TSJ^2 + TIJ^2)^1/2 + DJ) / 2 + PE
    Total System Jitter     (TSJ):    0.071ns
    Total Input Jitter      (TIJ):    0.000ns
    Discrete Jitter          (DJ):    0.000ns
    Phase Error              (PE):    0.000ns

    Location             Delay type                Incr(ns)  Path(ns)    Netlist Resource(s)
  -------------------------------------------------------------------    -------------------
                         (clock dev_data_ch1_in_out[dac_clk] rise edge)
                                                      0.001     0.001 r  
                                                      0.000     0.001 f  dev_data_clk_in[DATA_CLK_P] (IN)
                         net (fo=0)                   0.973     0.974    worker/dev_data_clk_in[DATA_CLK_P]
                         LUT1 (Prop_lut1_I0_O)        0.124     1.097 r  worker/dac_clk_bufr_i_1/O
                         net (fo=1, unplaced)         0.800     1.897    worker/dac_dev_data_clk_p
                         BUFR (Prop_bufr_I_O)         0.537     2.434 r  worker/dac_clk_bufr/O
                         net (fo=20, unplaced)        0.584     3.018    worker/dac_clk
                         BUFR (Prop_bufr_I_O)         1.031     4.049 r  worker/BUFR_inst/O
                         net (fo=91, unplaced)        0.584     4.633    worker/dev_data_ch1_in_out[dac_clk]
                         FDRE                                         r  worker/data_mode_lvds.reg_duplication_loop[6].dacd2_ch0_i_r_reg[6]/C
  -------------------------------------------------------------------    -------------------
                         FDRE (Prop_fdre_C_Q)         0.478     5.111 r  worker/data_mode_lvds.reg_duplication_loop[6].dacd2_ch0_i_r_reg[6]/Q
                         net (fo=2, unplaced)         0.752     5.863    worker/data_mode_lvds.reg_duplication_loop[6].dacd2_ch0_i_r_reg_n_0_[6]
                         LUT3 (Prop_lut3_I0_O)        0.295     6.158 r  worker/data_mode_lvds.dac_data_ddr_first_r[0]_i_3/O
                         net (fo=1, unplaced)         0.000     6.158    worker/dacd2_i_r__0[6]
                         MUXF7 (Prop_muxf7_I1_O)      0.247     6.405 r  worker/data_mode_lvds.dac_data_ddr_first_r_reg[0]_i_1/O
                         net (fo=1, unplaced)         0.000     6.405    worker/data_mode_lvds.dac_data_ddr_first_r_reg[0]_i_1_n_0
                         FDRE                                         r  worker/data_mode_lvds.dac_data_ddr_first_r_reg[0]/D
  -------------------------------------------------------------------    -------------------

                         (clock clk2 fall edge)       0.002     0.002 f  
                                                      0.000     0.002 f  dev_data_clk_in[DATA_CLK_P] (IN)
                         net (fo=0)                   0.924     0.927    worker/dev_data_clk_in[DATA_CLK_P]
                         LUT1 (Prop_lut1_I0_O)        0.100     1.027 r  worker/dac_clk_bufr_i_1/O
                         net (fo=1, unplaced)         0.760     1.787    worker/dac_dev_data_clk_p
                         BUFR (Prop_bufr_I_O)         0.486     2.273 r  worker/dac_clk_bufr/O
                         net (fo=20, unplaced)        0.439     2.712    worker/dac_clk
                         FDRE                                         r  worker/data_mode_lvds.dac_data_ddr_first_r_reg[0]/C
                         clock pessimism              0.163     2.875    
                         clock uncertainty           -0.035     2.839    
                         FDRE (Setup_fdre_C_D)        0.080     2.919    worker/data_mode_lvds.dac_data_ddr_first_r_reg[0]
  -------------------------------------------------------------------
                         required time                          2.919    
                         arrival time                          -6.405    
  -------------------------------------------------------------------
                         slack                                 -3.485    


\end{lstlisting}
\fontsize{10}{12}\selectfont
In order to calculate the clock period which would give a 0.000 ns slack, we add 2*0.001 ns to the slack violation which corresponded to a 0.001 ns period. For this example, the result is -(-3.485) + 2*(0.001) = 3.487 ns. The inverse of this value is what corresponds to the 286 MHz measurement in the table above\textsuperscript{\ref{measurement}}. This measurement can be verified by re-defining the clock period to have a period of 3.487 ns and re-running the timing report to see a worst case slack of 0 ns.
\begin{lstlisting}
create_clock -name clk2 -period 3.487 [get_nets dev_data_clk*]
report_timing -delay_type min_max
\end{lstlisting}
\fontsize{6}{12}\selectfont
\begin{lstlisting}[language=bash]

Timing Report

Slack (MET) :             0.000ns  (required time - arrival time)
  Source:                 worker/data_mode_lvds.reg_duplication_loop[6].dacd2_ch0_i_r_reg[6]/C
                            (rising edge-triggered cell FDRE clocked by dev_data_ch1_in_out[dac_clk]  {rise@1.743ns fall@5.230ns period=6.974ns})
  Destination:            worker/data_mode_lvds.dac_data_ddr_first_r_reg[0]/D
                            (rising edge-triggered cell FDRE clocked by clk2'  {rise@0.000ns fall@1.743ns period=3.487ns})
  Path Group:             clk2
  Path Type:              Setup (Max at Slow Process Corner)
  Requirement:            3.487ns  (clk2 fall@5.230ns - dev_data_ch1_in_out[dac_clk] rise@1.743ns)
  Data Path Delay:        1.772ns  (logic 1.020ns (57.562%)  route 0.752ns (42.438%))
  Logic Levels:           2  (LUT3=1 MUXF7=1)
  Clock Path Skew:        -1.760ns (DCD - SCD + CPR)
    Destination Clock Delay (DCD):    2.709ns = ( 7.940 - 5.230 ) 
    Source Clock Delay      (SCD):    4.632ns = ( 6.376 - 1.743 ) 
    Clock Pessimism Removal (CPR):    0.163ns
  Clock Uncertainty:      0.035ns  ((TSJ^2 + TIJ^2)^1/2 + DJ) / 2 + PE
    Total System Jitter     (TSJ):    0.071ns
    Total Input Jitter      (TIJ):    0.000ns
    Discrete Jitter          (DJ):    0.000ns
    Phase Error              (PE):    0.000ns

    Location             Delay type                Incr(ns)  Path(ns)    Netlist Resource(s)
  -------------------------------------------------------------------    -------------------
                         (clock dev_data_ch1_in_out[dac_clk] rise edge)
                                                      1.743     1.743 r  
                                                      0.000     1.743 f  dev_data_clk_in[DATA_CLK_P] (IN)
                         net (fo=0)                   0.973     2.716    worker/dev_data_clk_in[DATA_CLK_P]
                         LUT1 (Prop_lut1_I0_O)        0.124     2.840 r  worker/dac_clk_bufr_i_1/O
                         net (fo=1, unplaced)         0.800     3.640    worker/dac_dev_data_clk_p
                         BUFR (Prop_bufr_I_O)         0.537     4.177 r  worker/dac_clk_bufr/O
                         net (fo=20, unplaced)        0.584     4.761    worker/dac_clk
                         BUFR (Prop_bufr_I_O)         1.031     5.792 r  worker/BUFR_inst/O
                         net (fo=91, unplaced)        0.584     6.376    worker/dev_data_ch1_in_out[dac_clk]
                         FDRE                                         r  worker/data_mode_lvds.reg_duplication_loop[6].dacd2_ch0_i_r_reg[6]/C
  -------------------------------------------------------------------    -------------------
                         FDRE (Prop_fdre_C_Q)         0.478     6.854 r  worker/data_mode_lvds.reg_duplication_loop[6].dacd2_ch0_i_r_reg[6]/Q
                         net (fo=2, unplaced)         0.752     7.606    worker/data_mode_lvds.reg_duplication_loop[6].dacd2_ch0_i_r_reg_n_0_[6]
                         LUT3 (Prop_lut3_I0_O)        0.295     7.901 r  worker/data_mode_lvds.dac_data_ddr_first_r[0]_i_3/O
                         net (fo=1, unplaced)         0.000     7.901    worker/dacd2_i_r__0[6]
                         MUXF7 (Prop_muxf7_I1_O)      0.247     8.148 r  worker/data_mode_lvds.dac_data_ddr_first_r_reg[0]_i_1/O
                         net (fo=1, unplaced)         0.000     8.148    worker/data_mode_lvds.dac_data_ddr_first_r_reg[0]_i_1_n_0
                         FDRE                                         r  worker/data_mode_lvds.dac_data_ddr_first_r_reg[0]/D
  -------------------------------------------------------------------    -------------------

                         (clock clk2 fall edge)       5.230     5.230 f  
                                                      0.000     5.230 f  dev_data_clk_in[DATA_CLK_P] (IN)
                         net (fo=0)                   0.924     6.155    worker/dev_data_clk_in[DATA_CLK_P]
                         LUT1 (Prop_lut1_I0_O)        0.100     6.255 r  worker/dac_clk_bufr_i_1/O
                         net (fo=1, unplaced)         0.760     7.015    worker/dac_dev_data_clk_p
                         BUFR (Prop_bufr_I_O)         0.486     7.501 r  worker/dac_clk_bufr/O
                         net (fo=20, unplaced)        0.439     7.940    worker/dac_clk
                         FDRE                                         r  worker/data_mode_lvds.dac_data_ddr_first_r_reg[0]/C
                         clock pessimism              0.163     8.103    
                         clock uncertainty           -0.035     8.067    
                         FDRE (Setup_fdre_C_D)        0.080     8.147    worker/data_mode_lvds.dac_data_ddr_first_r_reg[0]
  -------------------------------------------------------------------
                         required time                          8.147    
                         arrival time                          -8.148    
  -------------------------------------------------------------------
                         slack                                  0.000    
\end{lstlisting}
\end{document}
